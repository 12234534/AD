<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>耗材消耗量计算器</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .config-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .consumption-table { margin-top: 20px; }
        .required::after { content: "*"; color: red; margin-left: 3px; }
    </style>
</head>
<body class="container-lg">
    <h2 class="my-4">耗材消耗量计算系统</h2>
    
    <!-- 基础设置 -->
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label required">检测方式</label>
            <select class="form-select" id="testMethod">
                <option value="随到随测">随到随测</option>
                <option value="集中检测">集中检测</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label required">机型</label>
            <select class="form-select" id="machineType">
                <option>YnY 2030</option>
                <option>YnY 2050</option>
                <option>YnY 3030</option>
            </select>
        </div>
    </div>

    <!-- 项目配置 -->
    <div class="my-4">
        <h4>项目配置项</h4>
        <div id="configItems">
            <div class="config-item">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label required">项目类别</label>
                        <select class="form-select category" onchange="updateTestType(this)">
                            <option>心肌标志物</option>
                            <option>炎症</option>
                            <option>性激素</option>
                        </select>
                    </div>
                    <!-- 其他下拉菜单和输入框 -->
                </div>
                <button class="btn btn-danger btn-sm mt-2" onclick="removeConfigItem(this)">删除</button>
            </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="addConfigItem()">新增配置项</button>
    </div>

    <!-- 耗材消耗表格 -->
    <table class="table table-bordered consumption-table">
        <thead class="table-light">
            <tr>
                <th>序号</th>
                <th>名称</th>
                <th>规格</th>
                <th>月度消耗量（30天）</th>
                <th>年度消耗量（365天）</th>
            </tr>
        </thead>
        <tbody id="consumptionBody">
            <!-- 耗材数据将通过JavaScript填充 -->
        </tbody>
    </table>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化配置项数据和事件监听
        // 此处应包含完整的JavaScript代码来处理：
        // 1. 动态添加/删除配置项
        // 2. 更新检测项目选项
        // 3. 执行计算逻辑
        // 4. 更新耗材表格
        
        // 由于代码长度限制，这里仅展示部分关键逻辑
        // 完整实现需要处理所有计算规则和动态交互
        function addConfigItem() {
    const newItem = document.createElement('div');
    newItem.className = 'config-item';
    newItem.innerHTML = `
        <div class="row g-3">
            <!-- 下拉菜单和输入框结构 -->
        </div>
        <button class="btn btn-danger btn-sm mt-2" onclick="removeConfigItem(this)">删除</button>
    `;
    document.getElementById('configItems').appendChild(newItem);
}

function removeConfigItem(button) {
    button.closest('.config-item').remove();
    calculateConsumption();
}
function updateTestProjects(select) {
    const category = select.value;
    const testType = select.closest('.config-item').querySelector('.test-type').value;
    const projectSelect = select.closest('.config-item').querySelector('.test-project');
    
    // 根据类别和检测类型更新选项
    let options = '';
    if(category === '心肌标志物') {
        if(testType === '单测项目') {
            options = `<option>高敏心肌肌钙蛋白-T (cTnT)</option>...`;
        } else {
            options = `<option>高敏心肌肌钙蛋白-T+肌红蛋白...</option>...`;
        }
    }
    // 其他类别处理...
    projectSelect.innerHTML = options;
    calculateConsumption();
}
function calculateConsumption() {
    let totals = {
        LB: 0,
        KC: 0,
        clean: 0,
        cup: 0
    };

    document.querySelectorAll('.config-item').forEach(item => {
        const testMethod = document.getElementById('testMethod').value;
        const dailySamples = Number(item.querySelector('.daily-samples').value);
        const testType = item.querySelector('.test-type').value;
        const projects = item.querySelector('.test-project').selectedOptions.length;

        // 根据检测方式和检测类型计算消耗量
        if(testMethod === '随到随测') {
            if(testType === '单测项目') {
                totals.LB += dailySamples * 4;
                totals.KC += dailySamples * 5;
                totals.clean += dailySamples * 150;
                totals.cup += dailySamples * 1;
            } else {
                totals.LB += dailySamples * projects + 4;
                totals.KC += dailySamples * projects + 5;
                totals.clean += (dailySamples * projects - 1) * 175;
                totals.cup += dailySamples * projects;
            }
        }
        // 其他计算规则...
    });

    // 更新表格显示
    updateConsumptionTable(totals);
}
function updateConsumptionTable(totals) {
    const monthlyLB = (totals.LB * 30 / 920).toFixed(2);
    const yearlyLB = (totals.LB * 365 / 920).toFixed(2);
    
    document.getElementById('consumptionBody').innerHTML = `
        <tr>
            <td>1</td>
            <td>发光缓冲液（LB）</td>
            <td>4×500ml/盒</td>
            <td>${monthlyLB}</td>
            <td>${yearlyLB}</td>
        </tr>
        <!-- 其他耗材行 -->
    `;
}
// 检测项目数据配置
const testProjects = {
    '心肌标志物': {
        '单测项目': [
            '高敏心肌肌钙蛋白-T (cTnT)',
            '肌红蛋白（MYO）',
            '肌酸激酶同工酶（CK-MB）',
            '氨基末端脑利钠钛前（NT-proBNP）',
        ],
        '联检项目': [
            '高敏心肌肌钙蛋白-T+肌红蛋白+肌酸激酶同工酶+氨基末端脑利钠钛前（cTnT+MYO+CK-MB+NT-proBNP）',
            '高敏心肌肌钙蛋白-T+肌红蛋白+肌酸激酶同工酶（cTnT+MYO+CK-MB）',
            '高敏心肌肌钙蛋白-T+氨基末端脑利钠钛前（cTnT+NT-proBNP）',
            '高敏心肌肌钙蛋白-T+肌红蛋白（cTnT+MYO）',
            '高敏心肌肌钙蛋白-T+肌酸激酶同工酶（cTnT+CK-MB）',
            '肌红蛋白+肌酸激酶同工酶（cTnT+MYO+CK-MB）',
            // 其他联检选项...
        ]
    },
    '炎症': {
        '单测项目': ['降钙素原（PCT）', '白介素6（IL-6）'],
        '联检项目': ['降钙素原+白介素6（PCT+IL-6）']
    },
    '性激素': {
        '单测项目': [
            '人绒毛膜促性腺激素（HCG）',
            '孕酮（PROG）',
            '抗缪勒管激素（AMH）'
        ],
        '联检项目': ['人绒毛膜促性腺激素+孕酮（HCG+PROG）']
    }
};

// 1. 动态配置项管理
function addConfigItem() {
    const newItem = document.createElement('div');
    newItem.className = 'config-item';
    newItem.innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label required">项目类别</label>
                <select class="form-select category" onchange="updateTestType(this)">
                    ${['心肌标志物', '炎症', '性激素'].map(o => `<option>${o}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label required">检测类型</label>
                <select class="form-select test-type" onchange="updateTestProjects(this)">
                    <option>单测项目</option>
                    <option>联检项目</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label required">检测项目</label>
                <select class="form-select test-project" multiple>
                    ${generateProjectOptions('心肌标志物', '单测项目')}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label required">日样本量</label>
                <input type="number" class="form-control daily-samples" 
                       min="1" value="1" onchange="validateInput(this)">
            </div>
        </div>
        <button class="btn btn-danger btn-sm mt-2" onclick="removeConfigItem(this)">删除</button>
    `;
    document.getElementById('configItems').appendChild(newItem);
}

function removeConfigItem(btn) {
    btn.closest('.config-item').remove();
    calculateConsumption();
}

// 2. 动态更新检测项目
function generateProjectOptions(category, testType) {
    return testProjects[category][testType].map(p => 
        `<option value="${p}">${p}</option>`
    ).join('');
}

function updateTestProjects(select) {
    const configItem = select.closest('.config-item');
    const category = configItem.querySelector('.category').value;
    const testType = select.value;
    const projectSelect = configItem.querySelector('.test-project');
    
    projectSelect.innerHTML = generateProjectOptions(category, testType);
    calculateConsumption();
}

// 3. 核心计算逻辑
function calculateConsumption() {
    const configItems = document.querySelectorAll('.config-item');
    const testMethod = document.getElementById('testMethod').value;
    
    let totals = {
        LB: 0,     // 发光缓冲液
        KC: 0,     // 碱性清洗液
        clean: 0,  // 浓缩清洗液
        cup: 0     // 反应杯
    };

    configItems.forEach(item => {
        const testType = item.querySelector('.test-type').value;
        const dailySamples = Number(item.querySelector('.daily-samples').value);
        const projects = item.querySelector('.test-project').selectedOptions.length;

        // 根据检测方式计算
        if(testMethod === '随到随测') {
            if(testType === '单测项目') {
                totals.LB += dailySamples * 4;
                totals.KC += dailySamples * 5;
                totals.clean += dailySamples * 150;
                totals.cup += dailySamples * 1;
            } else {
                totals.LB += dailySamples * projects + 4;
                totals.KC += dailySamples * projects + 5;
                totals.clean += (dailySamples * projects - 1) * 175;
                totals.cup += dailySamples * projects;
            }
        } else { // 集中检测
            if(testType === '单测项目') {
                totals.LB += dailySamples * 1 + 4;
                totals.KC += dailySamples * 1 + 5;
                totals.clean += (dailySamples - 1) * 25 + 175;
                totals.cup += dailySamples * 1;
            } else {
                totals.LB += dailySamples * projects + 4;
                totals.KC += dailySamples * projects + 5;
                totals.clean += (dailySamples * projects - 1) * 175;
                totals.cup += dailySamples * projects;
            }
        }
    });

    updateConsumptionTable(totals);
}

// 4. 更新消耗表格
function updateConsumptionTable(totals) {
    const monthlyLB = (totals.LB * 30 / 920).toFixed(2);
    const yearlyLB = (totals.LB * 365 / 920).toFixed(2);
    
    const monthlyKC = (totals.KC * 30 / 920).toFixed(2);
    const yearlyKC = (totals.KC * 365 / 920).toFixed(2);
    
    const monthlyClean = (totals.clean * 30 / 2000).toFixed(2);
    const yearlyClean = (totals.clean * 365 / 2000).toFixed(2);
    
    const monthlyCup = totals.cup * 30;
    const yearlyCup = totals.cup * 365;

    document.getElementById('consumptionBody').innerHTML = `
        <tr>
            <td>1</td>
            <td>发光缓冲液（LB）</td>
            <td>4×500ml/盒</td>
            <td>${monthlyLB}</td>
            <td>${yearlyLB}</td>
        </tr>
        <tr>
            <td>2</td>
            <td>碱性清洗液（KC）</td>
            <td>4×500ml/盒</td>
            <td>${monthlyKC}</td>
            <td>${yearlyKC}</td>
        </tr>
        <tr>
            <td>3</td>
            <td>浓缩清洗液</td>
            <td>100ml/瓶</td>
            <td>${monthlyClean}</td>
            <td>${yearlyClean}</td>
        </tr>
        <tr>
            <td>4</td>
            <td>反应杯</td>
            <td>1000个/包</td>
            <td>${monthlyCup}</td>
            <td>${yearlyCup}</td>
        </tr>
    `;
}

// 输入验证
function validateInput(input) {
    if(input.value < 1) {
        input.value = 1;
        alert("日样本量不能小于1");
    }
    calculateConsumption();
}

// 初始化计算
document.querySelectorAll('select, input').forEach(element => {
    element.addEventListener('change', calculateConsumption);
});
calculateConsumption(); // 初始计算
    </script>
</body>
</html>
